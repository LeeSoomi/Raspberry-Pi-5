# lidar_reader.py

import subprocess
import re
import time

cmd = ["./ultra_simple", "--channel", "--serial", "/dev/ttyUSB0", "115200"]

pattern = re.compile(r"theta:\s*([0-9.]+)\s+Dist:\s*([0-9.]+)")

p = subprocess.Popen(cmd, cwd="/home/soo/rplidar_sdk/output/Linux/Release",
                     stdout=subprocess.PIPE, stderr=subprocess.STDOUT,
                     text=True, bufsize=1)

def get_front_min_dist_mm(front_center=0, half_window=20):
    front_min = None
    start = time.time()
    while time.time() - start < 0.2:  # 0.2초만 읽고 최신값으로 판단
        line = p.stdout.readline()
        if not line:
            break
        m = pattern.search(line)
        if not m:
            continue
        theta = float(m.group(1))
        dist = float(m.group(2))
        # 각도 정규화: 0도 기준 전방. (환경에 따라 전방 기준이 다르면 보정 필요)
        # 전방 구간: [360-half_window ~ 360) U [0 ~ half_window]
        if theta >= 360 - half_window or theta <= half_window:
            if dist > 0:
                front_min = dist if front_min is None else min(front_min, dist)
    return front_min

try:
    while True:
        d = get_front_min_dist_mm()
        print("front_min_mm:", d)
        time.sleep(0.05)

except KeyboardInterrupt:
    pass

finally:
    p.terminate()





# main_line_lidar.py
import time
import subprocess
import re
import sys

PORT = "/dev/ttyUSB0"
BAUD = "115200"
LIDAR_CWD = "/home/soo/rplidar_sdk/output/Linux/Release"
LIDAR_CMD = ["./ultra_simple", "--channel", "--serial", PORT, BAUD]

PATTERN1 = re.compile(r"theta:\s*([0-9.]+)\s+Dist:\s*([0-9.]+)")
PATTERN2 = re.compile(r"([0-9]+\.[0-9]+).*?(?:Dist:|dist:)\s*([0-9.]+)")

def start_lidar_process():
    p = subprocess.Popen(
        LIDAR_CMD,
        cwd=LIDAR_CWD,
        stdout=subprocess.PIPE,
        stderr=subprocess.STDOUT,
        text=True,
        bufsize=1
    )
    return p

def get_front_min_dist_mm(p, half_window=20, read_window_s=0.2, debug=False, debug_lines=10):
    front_min = None
    t0 = time.time()
    printed = 0

    while time.time() - t0 < read_window_s:
        line = p.stdout.readline()
        if not line:
            continue

        if debug and printed < debug_lines:
            print("RAW>", repr(line))
            printed += 1

        # 占쏙옙트 占쏙옙占싸듸옙 占쏙옙占쏙옙 占쌨쏙옙占쏙옙占쏙옙 占쏙옙占?占쏙옙占쏙옙 占쏙옙호
        if "cannot bind" in line.lower():
            raise RuntimeError(line.strip())

        m = PATTERN1.search(line) or PATTERN2.search(line)
        if not m:
            continue

        theta = float(m.group(1))
        dist = float(m.group(2))
        if dist <= 0:
            continue

        if theta >= 360 - half_window or theta <= half_window:
            front_min = dist if front_min is None else min(front_min, dist)

    return front_min

def main():
    print("LIDAR reader started")
    sys.stdout.flush()

    p = start_lidar_process()

    # 첫 占쏙옙占쏙옙占쏙옙占쏙옙 RAW 10占쌕몌옙 占쏙옙占쏙옙漫占?占쏙옙占쏙옙 占쏙옙占?占쏙옙占쏙옙 확占쏙옙
    debug_first = True

    try:
        while True:
            d = get_front_min_dist_mm(p, debug=debug_first)
            debug_first = False
            print("front_min_mm:", d)
            time.sleep(0.1)

    except KeyboardInterrupt:
        pass

    except Exception as e:
        print("ERROR:", e)

    finally:
        try:
            p.terminate()
        except Exception:
            pass
        print("bye")

if __name__ == "__main__":
    main()

