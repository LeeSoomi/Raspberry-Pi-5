1단계. 하드웨어 연결과 기본 인식 확인하기
  1) 라이다를 USB로 연결한다. 전원 불안정이면 오작동이 나기 쉬우니 
    가능하면 안정적인 정원을 사용한다.
  
  2)연결 확인을 한다.
    lsusb
    ls /dev/ttyUSB*
    dmesg | tail -50

>> 
정상이라면 Silicon Labs CP210x가 보이고, /dev/ttyUSB0가 잡힌다. 
dmesg에는 cp210x converter now attached to ttyUSB0 같은 로그가 나온다.

오류 A. /dev/ttyUSB0가 안 생김
 1) 케이블 불량, 허브/전원 문제, 포트 불량이 흔하다. 
  케이블 교체, 포트 변경, 전원 교체로 재확인한다.
  2)dmesg에 disconnect 반복이면 전원/케이블 쪽 확률이 높다.


2단계. 파이썬 패키지 설치 오류(PEP 668) 해결
  라즈베리파이 OS Bookworm에서는 pip install을 시스템 파이썬에 바로 하면 
  externally-managed-environment 오류가 난다. 
  해결은 가상환경을 쓰는 것이다.

  1)프로젝트 폴더에서 가상환경 생성 및 활성화
    cd /home/soo/cos
    python3 -m venv .venv
    source .venv/bin/activate
    python -V
    which python

   >> which python이 /home/soo/cos/.venv/bin/python이면 정상이다.

  2) rplidar 라이브러리 설치
    pip install --upgrade pip
    pip install rplidar

  오류 B. 가상환경을 선택했는데도 pip가 시스템으로 설치됨
    VSCode에서 인터프리터가 venv로 선택되어 있어도, 
    터미널이 venv 활성화가 안 된 상태일 수 있다.
    항상 source .venv/bin/activate 후 which python으로 확인한다.

3단계. 파이썬 rplidar에서 “Wrong body size / Descriptor length mismatch”가 나는 경우
    파이썬 rplidar, adafruit-circuitpython-rplidar 둘 다에서 Wrong body size, Descriptor length mismatch가 났다. 
    이 오류는 라이다 데이터 스트림이 라이브러리가 기대하는 프로토콜과 맞지 않거나, 
      시리얼 읽기가 깨질 때 자주 난다.
    이때는 “파이썬 라이브러리 디버깅”보다, 제조사 SDK 예제로 장치가 정상 데이터를 내는지 먼저 확정하는 게 가장 빠르다.


4단계. SLAMTEC 공식 SDK(rplidar_sdk)로 장치 동작 확정
  1) SDK 폴더 준비 및 빌드(이미 진행한 상태라면 생략)
  
  2) 실행 파일 위치 확인
  
      cd ~/rplidar_sdk
      find . -maxdepth 4 -type f -executable | grep -E "ultra_simple|simple_grabber"
  
  3) 포트 확인
  
      ls /dev/ttyUSB*
  
  4) ultra_simple 실행
    A1M8-R6는 보통 115200을 쓴다. (SDK 도움말에도 모델별 baud 목록이 출력됨)
  
      cd ~/rplidar_sdk/output/Linux/Release
      ./ultra_simple --channel --serial /dev/ttyUSB0 115200
  
  정상이라면 Lidar health status : OK가 나오고, 
  별표 형태의 스캔 표시 또는 theta/dist 데이터가 계속 출력된다.
  만일 theta: ... Dist: ...가 계속 나오면 정상. Ctrl+C로 끊고 다음으로

오류 C. Error, cannot bind to the specified serial port /dev/ttyUSB0
    이건 거의 항상 “포트가 이미 다른 프로세스가 점유 중”이다.
    확인과 종료는 이렇게 한다.

    sudo fuser -v /dev/ttyUSB0

  >> 예를 들어 ultra_simple이 잡고 있으면 PID가 나온다. 
    PID를 직접 종료한다.
      sudo kill -9 3670
  >> 다시 sudo fuser -v /dev/ttyUSB0에서 아무것도 안 나오면 재시도한다.

  
  가상환경 활성화
    cd /home/soo/cos
  
  가상환경 있는지 확인
    ls -a
  없으면 만들기
    python3 -m venv .venv
  가상환경 활성화
    source .venv/bin/activate

  확인거치기 
    가상환경에서 which python
    출력은 반드시 /home/soo/cos/.venv/bin/python
  pip도 venv 것인지 확인
    pip도 venv 것인지 확인
  필요패키지 설치
    pip install rplidar
  
  아래코드를 가상환경에서 실행
    python -u lidar_reader.py

# lidar_reader.py
import time
import subprocess
import re
import sys

PORT = "/dev/ttyUSB0"
BAUD = "115200"
LIDAR_CWD = "/home/soo/rplidar_sdk/output/Linux/Release"
LIDAR_CMD = ["./ultra_simple", "--channel", "--serial", PORT, BAUD]

PATTERN = re.compile(r"theta:\s*([0-9.]+)\s+Dist:\s*([0-9.]+)")

def start_proc():
    return subprocess.Popen(
        LIDAR_CMD,
        cwd=LIDAR_CWD,
        stdout=subprocess.PIPE,
        stderr=subprocess.STDOUT,
        text=True,
        bufsize=1,
    )

def get_front_min_dist_mm(p, half_window=20, read_window_s=0.20, debug_lines=8):
    front_min = None
    t0 = time.time()
    dbg = 0

    while time.time() - t0 < read_window_s:
        line = p.stdout.readline()
        if not line:
            continue

        if dbg < debug_lines:
            print("RAW>", line.rstrip())
            dbg += 1

        m = PATTERN.search(line)
        if not m:
            continue

        theta = float(m.group(1))
        dist = float(m.group(2))
        if dist <= 0:
            continue

        if theta >= 360 - half_window or theta <= half_window:
            front_min = dist if front_min is None else min(front_min, dist)

    return front_min

def main():
    p = start_proc()
    try:
        print("LIDAR reader started")
        time.sleep(0.2)

        while True:
            d = get_front_min_dist_mm(p)
            print("front_min_mm:", d)
            time.sleep(0.1)

    except KeyboardInterrupt:
        pass
    finally:
        try:
            p.terminate()
        except Exception:
            pass
        print("bye")

if __name__ == "__main__":
    main()

# 실행 
python -u /home/soo/cos/lidar_reader.py
